# 第一阶段：构建 Python 依赖（wheel 缓存）
FROM python:3.12-slim-bullseye AS backend-builder

WORKDIR /app/backend

# 使用中科大 Debian 源
RUN sed -i 's|deb.debian.org|mirrors.ustc.edu.cn|g' /etc/apt/sources.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends gcc && \
    rm -rf /var/lib/apt/lists/*

# 设置 pip 国内源（一次性配置）
ENV PIP_INDEX_URL=https://pypi.tuna.tsinghua.edu.cn/simple
ENV PIP_EXTRA_INDEX_URL=https://mirrors.aliyun.com/pypi/simple/  
ENV PIP_TIMEOUT=120

# 升级 pip
RUN pip install --upgrade pip

# 仅复制 requirements.txt 以利用缓存
COPY requirements.txt .

# 单独下载 PyTorch CPU wheel（避免从 requirements.txt 安装导致超时或 GPU 版本）
RUN pip wheel --no-cache-dir --no-deps --wheel-dir /wheels \
    torch>=1.8.0 -f https://download.pytorch.org/whl/cpu/torch_stable.html

# 下载其余依赖的 wheels（排除 torch，避免重复或冲突）
RUN pip wheel --no-cache-dir --no-deps --wheel-dir /wheels -r requirements.txt


# 第二阶段：最终运行镜像
FROM python:3.12-slim-bullseye

WORKDIR /app

# 创建非 root 用户（指定 UID/GID 更安全，可选）
RUN useradd --create-home --shell /bin/bash appuser

# 安装系统依赖（PyTorch CPU + OpenCV 等常见库所需）
RUN sed -i 's|deb.debian.org|mirrors.ustc.edu.cn|g' /etc/apt/sources.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        libgomp1 \
        libgl1-mesa-glx \
        libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# 复制 wheels 和 requirements.txt
COPY --from=backend-builder /wheels /wheels
COPY --from=backend-builder /app/backend/requirements.txt .

# 安装所有 wheels（按依赖顺序自动解析）
# 注意：pip install /wheels/* 可能因顺序失败，改用 -f 指定 find-links
RUN pip install --no-cache-dir --find-links /wheels --no-index -r requirements.txt && \
    rm -rf /wheels

# 复制应用代码（应在依赖之后，避免缓存失效）
COPY . .

# 权限加固
RUN chown -R appuser:appuser /app
USER appuser

# 暴露端口
EXPOSE 8000

# 启动命令（假设入口为 backend/main.py）
CMD ["uvicorn", "backend.main:app", "--host", "0.0.0.0", "--port", "8000"]